+++
title = "Emacsã§LLM"
author = ["YAMASHITA Takao"]
date = 2024-11-10T22:33:00+09:00
lastmod = 2024-11-10T23:01:13+09:00
tags = ["Emacs", "LLM-OLLAMA", "ellama"]
categories = ["Emacs", "LLM-OLLAMA", "ellama"]
draft = false
pin = false
+++

## ã‚ãŸã‚‰ã—ã„ã€ãŠã‚‚ã¡ã‚ƒ Ollama {#ã‚ãŸã‚‰ã—ã„-ãŠã‚‚ã¡ã‚ƒ-ollama}

æ˜¨æ—¥ã²ã•ã—ã¶ã‚Šã«æœ¬å±‹ã«è¡Œã£ã¦ç«‹ã¡èª­ã¿ã—ã¦ãŸã‚‰ã€Macã®Ollamaã§LLMã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§éŠã¶ã¿ãŸã„ãªè¨˜äº‹ãŒã‚ã£ãŸã€‚
é£ŸæŒ‡ããã‚‰ã‚Œã‚‹æ€ã„ã§ã€æ—©é€Ÿã€ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å‹•ä½œç¢ºèªã‚’ã—ãŸã¨ã“ã‚ã€ãã‚Œãªã‚Šã«éŠã¹ãã†ã ã‹ã‚‰å¹´æœ«å¹´å§‹ã«å‹‰å¼·ã—ã‚ˆã†ã€‚

[Ollamaã§åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«](https://ollama.com/library) ã‚‚è±Šå¯Œã§ã€ã›ã£ã›ã¨ã‚¢ãƒƒãƒ—ã—ã¦ãã‚Œã‚‹æ–‡åŒ–ãŒã‚ã£ãŸã®ã§ã€Emacsã§å‹•ä½œã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ã‚ã‚‹ã§ã—ã‚‡ã£ã¦ã“ã¨ã§ã€æœ€è¿‘ãŠæ°—ã«å…¥ã‚Šã® [Perplexity](https://www.perplexity.ai) ã§èª¿ã¹ãŸã€‚[Google](https://www.google.com) ã§ã‚‚ã„ã„ã ã‘ã©ã€ã‚µãƒƒã‚¯ã¨èª¿ã¹ã¦ãã‚Œã‚‹ã‹ã‚‰ã€‚

ä»¥ä¸‹ã€Perplexityã‹ã‚‰ã®ã‚³ãƒ”ãƒšãŒæ··ã–ã£ã¦ã„ã‚‹ã®ã§ã€è©±ã—è¨€è‘‰ã¨æ–‡èªä½“ãŒæ··åœ¨ã§ã™ğŸ˜…

Ollamaã‚’macOSã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€Emacsã‹ã‚‰Ellamaã‚’è¨­å®šã—ã¦åˆ©ç”¨ã™ã‚‹æ‰‹é †ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚


### Ollamaã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«[^fn:1] {#ollamaã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«}

1.  **Homebrewã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**::
    ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    ```bash
    brew install ollama
    ```

2.  **Ollamaã®å‹•ä½œç¢ºèª**::
    ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ```bash
    ollama --version
    ```

3.  **ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨å®Ÿè¡Œ**::
    ä¾‹ãˆã°ã€\`gemma2:9b\`ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†å ´åˆã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    ```bash
    ollama run gemma2:9b
    ```

4.  **å¯¾è©±ã‚’çµ‚äº†ã™ã‚‹ã«ã¯**::
    ```basn
    Ctrl + d ã¾ãŸã¯ /bye
    ```


### Emacsã§Ellamaã®è¨­å®š {#emacsã§ellamaã®è¨­å®š}

1.  **Emacsã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**:
    `use-package` ã‚’ä½¿ç”¨ã—ã¦Ellamaã‚’è¨­å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã®è¨­å®šã‚’Emacsã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆé€šå¸¸ã¯ `~/.emacs.d/init.el` ï¼‰ã«è¿½åŠ ã—ã¾ã™ã€‚
    ```emacs-lisp
    (use-package ellama
      :init
      (setq ellama-keymap-prefix "C-c e")  ;; ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®è¨­å®š
      (setq ellama-language "Japanese")      ;; è¨€èªè¨­å®š
      (require 'llm-ollama)
      (setq ellama-provider (make-llm-ollama
        :host "localhost"                     ;; OllamaãŒå‹•ä½œã—ã¦ã„ã‚‹ãƒ›ã‚¹ãƒˆå
        :chat-model "gemma2:9b"               ;; ä½¿ç”¨ã™ã‚‹ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«å
        :embedding-model "gemma2:9b")))       ;; ä½¿ç”¨ã™ã‚‹åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«å
    ```

2.  **Emacsã‹ã‚‰Ellamaã‚’ä½¿ç”¨ã™ã‚‹**:
    Emacså†…ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
    -   ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ: \`M-x ellama-make-table\`
    -   YAMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›: \`M-x ellama-make-format RET yaml RET\`
    -   æ¦‚è¦ä½œæˆ: \`M-x ellama-summarize\`
    -   ç¿»è¨³: \`M-x ellama-translate\`

ç§ã¯[ leaf ](https://github.com/conao3/leaf.el)ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€æŠœç²‹ã—ãŸã‚‚ã®ã‚’è²¼ã‚Šä»˜ã‘ã¦ãŠãã€‚

```emacs-lisp
(leaf ellama
  :after llm-ollama
  :ensure t
  :init
  (setopt ellama-language "Japanese")
  (setopt ellama-sessions-directory (concat no-littering-var-directory "ellama-sessions"))
  (setopt ellama-naming-scheme 'ellama-generate-name-by-llm)
  (setopt ellama-provider
          (make-llm-ollama
           ;; this model should be pulled to use it
           ;; value should be the same as you print in terminal during pull
           :chat-model "llama3:8b-instruct-q8_0"
           :embedding-model "nomic-embed-text"
           :default-chat-non-standard-params '(("num_ctx" . 8192))))
  (setopt ellama-summarization-provider
          (make-llm-ollama
           :chat-model "qwen2.5:3b"
           :embedding-model "nomic-embed-text"
           :default-chat-non-standard-params '(("num_ctx" . 32768))))
  ;; llm providers for interactive switching.
  (setopt ellama-providers
          '(("zephyr" . (make-llm-ollama
                         :chat-model "zephyr:7b-beta-q6_K"
                         :embedding-model "zephyr:7b-beta-q6_K"))
            ("mistral" . (make-llm-ollama
                          :chat-model "mistral:7b-instruct-v0.2-q6_K"
                          :embedding-model "mistral:7b-instruct-v0.2-q6_K"))
            ("mixtral" . (make-llm-ollama
                          :chat-model "mixtral:8x7b-instruct-v0.1-q3_K_M-4k"
                          :embedding-model "mixtral:8x7b-instruct-v0.1-q3_K_M-4k"))
            ("codestral" . (make-llm-ollama
                            :chat-model "codestral:22b-v0.1-q4_K_S"
                            :embedding-model "codestral:22b-v0.1-q4_K_S"))
            ("gemma2" . (make-llm-ollama
                         :chat-model "gemma2:27b-instruct-q4_K_S"
                         :embedding-model "gemma2:27b-instruct-q4_K_S"))
            ("command-r" . (make-llm-ollama
                            :chat-model "command-r:35b"
                            :embedding-model "command-r:35b"))
            ("llama3.1" . (make-llm-ollama
                           :chat-model "llama3.1:8b"
                           :embedding-model "llama3.1:8b"))))
  ;; Naming new sessions with llm
  (setopt ellama-naming-provider
          (make-llm-ollama
           :chat-model "llama3:8b-instruct-q8_0"
           :embedding-model "nomic-embed-text"
           :default-chat-non-standard-params '(("stop" . ("\n")))))
  ;; Translation llm provider
  (setopt ellama-translation-provider
          (make-llm-ollama
           :chat-model "qwen2.5:3b"
           :embedding-model "nomic-embed-text"
           :default-chat-non-standard-params
           '(("num_ctx" . 32768)))))
```


### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆModelfileï¼‰ã®ä½œæˆ {#è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«-modelfile-ã®ä½œæˆ}

Ollamaã§ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ <span class="underline">Modelfile</span> ãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã¯ãã®ä¾‹ã§ã™ã€‚

1.  **Modelfileã®ä½œæˆ**:
    ãƒ¢ãƒ‡ãƒ«ã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `Modelfile` ã¨ã„ã†åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

<!--listend-->

```shell
from /ollama/gemma2-9b-chat-gguf
```


## Ellamaã§éŠã‚“ã  {#ellamaã§éŠã‚“ã }

`M+x ellama-chat` ã§ã€ãŠéŠã³ã—ãŸã‘ã©ã€ã¡ã‚ƒã‚“ã¨ã—ã¦ã„ã¦é©šã„ãŸğŸ¤£


### User: {#user}

emacs29ä»¥ä¸Šã§å‹•ä½œã™ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«


### Ellama: {#ellama}

Emacs29ã‹ã‚‰ä¸Šæ‰‹ãå‹•ä½œã™ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```el
;;; config.el - Emacs config file

;; Emacsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯
(unless (>= emacs-major-version 29)
  (error "Emacs 29ä»¥ä¸Šã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"))

;; åŸºæœ¬è¨­å®š
(setq default-frame-alist '((top . 0) (left . 0) (width . 1400) (height . 800)))
(setq mouse-wheel-movement 2) ; ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã®å›è»¢é‡
(setq tab-width 2) ; Tabã‚­ãƒ¼ã®ã‚¿ãƒ–å¹…
(setq indent-tabs-mode nil) ; ã‚¿ãƒ–ã‚’ç©ºç™½ã§ç½®æ›ã™ã‚‹
(setq show-paren-mode t) ; æ‹¬å¼§ã®è¡¨ç¤º
(setq show-trailing-whitespace t) ; ä¸è¦ãªã‚¹ãƒšãƒ¼ã‚¹ã®è¡¨ç¤º
(setq enable-pop-up-menu t) ; Pop-up menuã®æœ‰åŠ¹åŒ–
(setq scroll-step-1 120) ; Scrollãƒãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡
(setq column-number-mode t) ; è¡Œæ•°ã¨åˆ—æ•°ã‚’è¡¨ç¤ºã™ã‚‹

;; ã‚­ãƒ¼ãƒã‚¤ãƒ³ã‚°
(global-set-key [C-left] 'previous-line) ; Ctrl + Left Arrow
(global-set-key [C-right] 'next-line') ; Ctrl + Right Arrow
(global-set-key [C-x C-k] 'kill-region') ; Ctrl + X + K
(global-set-key [C-x C-c] 'copy-region') ; Ctrl + X + C
(global-set-key [C-x C-y] 'yank') ; Ctrl + X + Y
(global-set-key [C-x C-w] 'cut-region') ; Ctrl + X + W
(global-set-key [C-c C-f] 'find-file') ; Ctrl + C + F
(global-set-key [C-c C-s] 'save-some-buffers') ; Ctrl + C + S
(global-set-key [C-c C-q] 'write-region') ; Ctrl + C + Q
(global-set-key [C-c C-j] 'next-error') ; Ctrl + C + J
(global-set-key [C-c C-i] 'previous-error') ; Ctrl + C + I
(global-set-key [C-c C-k] 'kill-some-buffers') ; Ctrl + C + K
(global-set-key [M-.] 'undo') ; Option + .
(global-set-key [M-;] 'revert') ; Option + ;
(global-set-key [C-x o] 'other-frame') ; Ctrl + X + O
(global-set-key [C-x 5] 'minibuffer-scroll-down') ; Ctrl + X + 5 (ä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«)
(global-set-key [C-x 6] 'minibuffer-scroll-up') ; Ctrl + X + 6 (ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«)

;; ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æœ‰åŠ¹åŒ–
(package-initialize) ; Emacs Package Manager (EPM)ã®åˆæœŸåŒ–
(add-to-list 'load-path "/path/to/package/directory") ; ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ¢ç´¢å…ˆã®è¿½åŠ 
(require 'company) ; Company-modeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æœ‰åŠ¹åŒ–
(company-setup) ; Company-modeã®è¨­å®š

;; ãƒ†ãƒ¼ãƒã®é¸æŠ
(set-face-attribute 'default' nil :background "black") ; èƒŒæ™¯ã®è‰²ã‚’ç™½ã«ã™ã‚‹å ´åˆ
(load-theme 'gruvbox-dark' t) ; ãƒ†ãƒ¼ãƒã®æœ‰åŠ¹åŒ–

;; ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æœ‰åŠ¹åŒ–
(require 'org) ; Org-modeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æœ‰åŠ¹åŒ–
(setq org-mode '(text . plain) (html . html)) ; Org-modeã®å‡ºåŠ›å½¢å¼
(add-to-list 'auto-mode-alist '("\\.org" . org-mode)) ;  ".org" ã§ Org-mode ã‚’æœ‰åŠ¹åŒ–

;; ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç®¡ç†
(require 'projectile) ; Projectileãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æœ‰åŠ¹åŒ–
(projectile-global-mode 1) ; Projectile ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æœ‰åŠ¹åŒ–
(setq projectile-find-by-name t) ; Projectile ã§åå‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œç´¢ã‚’æœ‰åŠ¹åŒ–
```

ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€Emacs29ã‹ã‚‰ä¸Šæ‰‹ãå‹•ä½œã™ã‚‹è¨­å®šã‚’è¨˜è¿°ã—ã¦ã„ã¾Xã™ã€‚ç‰¹ã«ã€ã‚¨ãƒ‡ã‚£ã‚¿ã®åŸºæœ¬è¨­å®šã€ã‚­ãƒ¼
ãƒã‚¤ãƒ³ã‚°ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æœ‰åŠ¹åŒ–ã€ãƒ†ãƒ¼ãƒã®é¸æŠã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æœ‰åŠ¹åŒ–ãªã©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“
ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€é–‹ç™ºè€…ã‚„å­¦ç¿’è€…ãªã©ã«ã¨ã£ã¦å½¹ç«‹ã¤è¨­å®šãŒæä¾›ã•ã‚Œã¾ã™ã€‚

[^fn:1]: [Ollamaã®ãƒã‚¤ãƒŠãƒªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://ollama.com/download%20)
